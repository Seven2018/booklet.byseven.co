<div id='container-show-user'>
  <div class="user-top-background">
    <div class="user-buttons-top">
      <%= link_to organisation_path, class: 'btn return-arrow' do %><i class="fas fa-arrow-left"></i><% end %>
      <div id='show-buttons'>
        <% if current_user.access_level == 'Super Admin' || @user == current_user || (['Admin', 'HR'].include?(current_user.access_level) && current_user.company == @user.company) %>
          <a data-toggle='modal' data-target='#editUser'><button class='btn-edit-white btn-icon'><i class='fas fa-pen'></i></button></a>
          <a data-toggle='modal' data-target='#editPassword'><button class='btn-edit-white btn-icon btn-last'><i class="fas fa-key"></i></button></a>
        <% end %>
      </div>
    </div>
    <div class="user-top">
      <div class="user-photo">
        <% if @user.picture.present? %>
          <img src='<%= @user.picture %>' alt="" class='avatar-xlarge' onerror='this.onerror=null;this.src="<%= asset_url('empty-avatar.png', type: :image) %>";'>
        <% else %>
          <a data-toggle='modal' data-target='#editPicture' class="avatar-xlarge-empty centered-item">
            <h6>Add picture</h6>
          </a>
        <% end %>
      </div>
      <div class="user-contant">
        <div class='user-name'>
          <p><strong><%=  @user.firstname %> <%=  @user.lastname %></strong></p>
        </div>
        <div class="user-top-info">
          <div class='user-contact-info'>
            <p><i class="fas fa-envelope"></i> <%=  @user.email %></p>
            <p class="data" id='phone' onclick='openForm(this)'><i class="fas fa-phone"></i> <%=  @user.phone_number if @user.phone_number.present? %></p>
            <%= simple_form_for :user, url: user_path(@user, page: 'show', type: 'phone'), html: { class: "hidden hidden-form-user" }, method: :patch, remote: true, input_html: {multipart: true} do |f| %>
              <%= f.input :phone_number, label: false, input_html: {value: @user.phone_number} %>
              <%= button_tag :submit, class: 'hidden-submit' do %>
                <i class="fas fa-save"></i>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="user-secondary-container">
    <div class="user-dashboard-tabs">
      <div class="dashboard-tabs">
        <ul class="nav nav-tabs">
            <li role="presentation"><a href="#Overview" data-toggle="tab" class='active'>Overview</a></li>
            <li role="presentation"><a href="#Trainings" data-toggle="tab">Trainings</a></li>
        </ul>
      </div>
    </div>
    <div class="tab-content">
      <div role="tabpanel" class="tab-pane active" id="Overview">
        <div class="user-overview-grid">
          <div class="user-information">
            <p><b>Personal Info</b></p>
            <div class="user-access">
              <p><i class="fas fa-universal-access"></i> <%=  @user.access_level %></p>
            </div>
            <div class="user-work-info">
                <p> <i class="fas fa-briefcase"></i> <%= @user.company.name %></p>
              <div class="user-job">
                <p class="data" id='job' onclick='openForm(this)'> <%=  @user.job_title if @user.job_title.present? %></p>
                <%= simple_form_for :user, url: user_path(@user, page: 'show', type: 'job'), html: { class: "hidden hidden-form-user" }, method: :patch, remote: true, input_html: {multipart: true} do |f| %>
                  <%= f.input :job_title, label: false, input_html: {value: @user.job_title} %>
                  <%= button_tag :submit, class: 'hidden-submit' do %>
                    <i class="fas fa-save"></i>
                  <% end %>
                <% end %>
              </div>
              <div class="user-hire">
                <% if @user.hire_date.present? %>
                  <p class="data" id='hire_date' onclick='openForm(this)'> <%=  @user.hire_date %></p>
                <% else %>
                  <p class="data" id='birth_date' onclick='openForm(this)'>Hire Date</p>
                <% end %>
                <%= simple_form_for :user, url: user_path(@user, page: 'show', type: 'hire_date'), html: { class: "hidden hidden-form-user" }, method: :patch, remote: true, input_html: {multipart: true} do |f| %>
                  <%= f.input :hire_date, label: false, input_html: {class: 'datepicker'}, value: @user.hire_date %>
                  <%= button_tag :submit, class: 'hidden-submit' do %>
                        <i class="fas fa-save"></i>
                      <% end %>
                <% end %>
              </div>
            </div>
            <div class="user-birth">
              <i class="fas fa-birthday-cake"></i>
              <% if @user.birth_date.present? %>
                <p class="data" id='birth_date' onclick='openForm(this)'><%=  @user&.birth_date %></p>
              <% else %>
                <p class="data" id='birth_date' onclick='openForm(this)'>Birth Date</p>
              <% end %>
              <%= simple_form_for :user, url: user_path(@user, page: 'show', type: 'birth_date'), html: { class: "hidden hidden-form-user" }, method: :patch, remote: true, input_html: {multipart: true} do |f| %>
                <%= f.input :birth_date, label: false, input_html: {class: 'datepicker'}, value: @user.birth_date %>
                <%= button_tag :submit, class: 'hidden-submit' do %>
                  <i class="fas fa-save"></i>
                <% end %>
              <% end %>
            </div>
            <div class="user-tags">
              <i class="fas fa-user-tag"></i>
              <% @user.tags.each do |tag| %>
              <% if tag.tag_name.present? %>
                <div class='user-tag-name'><p><%= tag.tag_name %></p></div>
              <% else %>
                <p>No associated tags</p>
              <% end %>
              <% end %>
            </div>
          </div>
          <div class="interested-in">
            <p><b>Interested In <i class="fas fa-heart"></i></b></p>
            <% @user.user_interests.includes([:content]).where(interest_type: 'Interested').each do |interest| %>
             <% content = interest.content  %>
              <div class='user-card-interest'>
                <div class="user-card">
                  <div class="catalogue-content-card-left-user">
                    <div>
                      <% if content.title.length > 60 %>
                        <h3><b><%= content.title.first(60)+'...' %></b></h3>
                      <% else %>
                        <h3><b><%= content.title %></b></h3>
                      <% end %>
                      <p><%= content.duration %> Minutes</p>
                    </div>
                    <div class="type-icon">
                      <% if content.content_type == 'Synchronous' %>
                        <i class="fas fa-chalkboard-teacher" style='color:#F26419;'></i>
                      <% else %>
                        <i class="fas fa-laptop" style='color:black;'></i>
                      <% end %>
                    </div>
                  </div>
                  <% if content.content_type == 'Synchronous' %>
                    <div class="catalogue-content-card-right-syn-user">
                  <% else %>
                    <div class="catalogue-content-card-right-asyn-user">
                  <% end %>
                      <div class="catalogue-content-card-right-interest">
                        <% interest = UserInterest.find_by(content_id: content.id, user_id: current_user.id) %>
                        <% if interest.present? %>
                          <%= link_to user_interest_path(id: interest.id), method: :delete, remote: true do %>
                            <i class="fas fa-heart"></i>
                          <% end %>
                        <% else %>
                          <%= link_to user_interests_path(content_id: content.id), method: :post, remote: true do %>
                            <i class="far fa-heart"></i>
                          <% end %>
                        <% end %>
                        <p><%= content.interested.count %> Interested</p>
                      </div>
                    </div>
                    </div>
                <% end %>
                </div>
              </div>
          </div>
        </div>
      </div>
      <div role="tabpanel" class="tab-pane" id="Trainings">
        <div class="user-trainings">
          <p>Upcoming Trainings</p>
          <div class="trainings-row">
            <% Session.joins(:attendees).where(attendees: {user_id: @user.id}).where('date >= ?', Date.today).each do |content| %>
              <%= link_to training_content_path(content) do %>
                <div class="training-card-main">
                  <div class="upcoming-trainings-card">
                    <div class="user-training-title">
                      <% if content.title.length > 60 %>
                        <h3><b><%= content.title.first(60)+'...' %></b></h3>
                      <% else %>
                        <h3><b><%= content.title %></b></h3>
                      <% end %>
                    </div>
                    <p><i class="fas fa-calendar-alt"></i> <%= content.date.strftime('%d/%m/%Y') %></p>
                    <div class='content-time'><p><i class="fas fa-clock"></i> <%= content.duration %> min</p></div>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
          <p>Completed Trainings</p>
          <div class="trainings-row">
            <% Session.joins(:attendees).where(attendees: {user_id: @user.id}).where('date < ?', Date.today).each do |content| %>
              <%= link_to training_content_path(content) do %>
                <div class="training-card-main">
                  <div class="completed-trainings-card">
                    <div class="user-training-title">
                      <% if content.title.length > 60 %>
                        <h3><b><%= content.title.first(60)+'...' %></b></h3>
                      <% else %>
                        <h3><b><%= content.title %></b></h3>
                      <% end %>
                    </div>
                    <div class="user-training-bottom">
                      <p><i class="fas fa-calendar-alt"></i> <%= content.date.strftime('%d/%m/%Y') %></p>
                    <div class='content-time'><p><i class="fas fa-clock"></i> <%= content.duration %> min</p></div>
                    </div>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div>
  <% Assessment.joins(:user_forms).where(user_forms: {user_id: @user.id}).each do |form| %>
   <p><%= form.title %></p>
   <p>Grade : <%= UserForm.find_by(user_id: @user, mod_id: form.id)&.grade %>%</p>
  <% end %>
</div>

<!-- Modal -->
<div class="modal fade" id="editUser" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document" style="border-radius: 20px">
    <%= render 'edit', user: @user %>
  </div>
</div>

<div class="modal fade" id="editPicture" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document" style="border-radius: 20px">
    <%= render 'edit_picture', user: @user %>
  </div>
</div>

<div class="modal fade" id="editPassword" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document" style="border-radius: 20px">
    <%= render 'changepassword', user: @user %>
  </div>
</div>


<% if ['Super Admin', 'Admin', 'HR'].include?(current_user.access_level) %>
  <script>
    function openForm(element) {
      if (document.querySelector('.opened') == null) {
        form = element.parentNode.querySelector('.hidden-form-user');
        element.classList.toggle('hidden');
        form.classList.toggle('hidden');
        form.classList.toggle('opened');
      }
    };

    function fireDatePicker() {
      flatpickr(".datepicker", {
        disableMobile: true,
        dateFormat: "d/m/Y",
      })
    };
  </script>
  <script>
  sliders = document.querySelectorAll('.trainings-row');
  sliders.forEach((slider) => {
    isDown = false;
    let startX;
    let scrollLeft;

    slider.addEventListener('mousedown', (e) => {
      isDown = true;
      slider.classList.add('active');
      startX = e.pageX - slider.offsetLeft;
      scrollLeft = slider.scrollLeft;
    });
    slider.addEventListener('mouseleave', () => {
      isDown = false;
      slider.classList.remove('active');
    });
    slider.addEventListener('mouseup', () => {
      isDown = false;
      slider.classList.remove('active');
    });
    slider.addEventListener('mousemove', (e) => {
      if(!isDown) return;
      e.preventDefault();
      const x = e.pageX - slider.offsetLeft;
      const walk = (x - startX) * 3; //scroll-fast
      slider.scrollLeft = scrollLeft - walk;
      console.log(walk);
    });
  })
</script>
<% end %>
