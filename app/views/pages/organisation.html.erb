<div id="index-controls" class='flex-row-between-centered'>
  <h1>Employees</h1>
</div>
<div class='organization-page'>
  <div class='filter-dropdown-form'>
    <div class="hidden-form" id='filter-block'>
      <%= render 'organisation_ajax' %>
    </div>
  </div>
  <div class='organisation-users'>
    <div class='staff-members'>
      <h3 class="category-title"><b>Staff Members</b></h3>
      <div class='mobile-btns'>
        <div class="mobile-filter-btn">
          <i class="fas fa-sliders-h fa-2x"></i>
        </div>
        <% if ['Super Admin', 'Admin', 'HR'].include?(current_user.access_level) %>
        <button class="btn btn-edit-white btn-edit-icon dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fas fa-plus"></i></button>
        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
          <!-- <a data-toggle='modal' data-target='#newTagCategory' class='dropdown-item'>New Tag Category</a>
          <a data-toggle='modal' data-target='#newTag' class='dropdown-item'>New Tag</a> -->
          <a data-toggle='modal' data-target='#newUser' class='dropdown-item'>New User</a>
          <a data-toggle='modal' data-target='#importUsers' class='dropdown-item'>Import Users</a>
        </div>
      <% end %>
      </div>
    </div>
    <% @users.each do |user| %>
      <%= link_to user_path(user) do %>
        <div class='user-index-card'>
          <img src="<%= user.picture %>" alt="" class='avatar-sm' onerror='this.onerror=null;this.src="<%= asset_url('empty-avatar.png', type: :image) %>";'>
          <div class="user-index-infos flex-row-between-centered">
            <div class="user-index-info">
              <p data-toggle="tooltip" title="<%= user.fullname %>"><%= user.fullname %></p>
            </div>
            <div class="user-index-info">
              <p data-toggle="tooltip" title="<%= user.email %>"><%= user.email %></p>
            </div>
            <div class="user-index-info">
              <% tags = '' %>
              <% user.tags.each do |tag| %>
                <% if tag == user.tags.last %>
                  <% tags += "#{tag.tag_name}" %>
                <% else %>
                  <% tags += "#{tag.tag_name}, " %>
                <% end %>
              <% end %>
              <p data-toggle="tooltip" title="<%= tags %>"><%= tags %></p>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>



<!-- </div>
 -->
<!-- Modals -->
<div class='modal fade' id='newTagCategory' tabindex='-1' role='dialog' aria-labelledby='myModalLabel'  data-backdrop="static" data-keyboard="false">
  <div class='modal-dialog' role='document' style='border-radius: 20px'>
    <%= render 'tag_categories/new', tag_category: TagCategory.new %>
  </div>
</div>

<div class='modal fade' id='newTag' tabindex='-1' role='dialog' aria-labelledby='myModalLabel'  data-backdrop="static" data-keyboard="false">
  <div class='modal-dialog' role='document' style='border-radius: 20px'>
    <%= render 'tags/new', tag: Tag.new %>
  </div>
</div>

<div class='modal fade' id='newUser' tabindex='-1' role='dialog' aria-labelledby='myModalLabel'  data-backdrop="static" data-keyboard="false">
  <div class='modal-dialog' role='document' style='border-radius: 20px'>
    <%= render 'users/new', tag: User.new %>
  </div>
</div>

<div class='modal fade' id='importUsers' tabindex='-1' role='dialog' aria-labelledby='myModalLabel'  data-backdrop="static" data-keyboard="false">
  <div class='modal-dialog' role='document' style='border-radius: 20px'>
    <%= render 'users/import', tag: User.new %>
  </div>
</div>

<script>
  /* When the user clicks on the button,
  toggle between hiding and showing the dropdown content */
  function myFunction() {
    document.getElementById("myDropdown").classList.toggle("show");
  }

  function outsideClick(event, notelem) {
    notelem = $(notelem); // jquerize (optional)
    // check outside click for multiple elements
    var clickedOut = true, i, len = notelem.length;
    for (i = 0;i < len;i++)  {
        if (event.target == notelem[i] || notelem[i].contains(event.target)) {
            clickedOut = false;
        }
    }
    if (clickedOut) return true;
    else return false;
  }

  function openForm(element) {
    control_buttons = element.parentNode.parentNode.querySelectorAll('.icon-btn');
    target_form = element.parentNode.querySelector('.hidden-form-ajax');
    form_container = element.parentNode.parentNode
    control_buttons.forEach((el) => {
      el.classList.add('hidden');
    })
    target_form.classList.remove('hidden');
    isClicked = false;
    window.addEventListener('click', function(e) {
      if (outsideClick(e, form_container)) {
        if(!isClicked){
          form_container.querySelectorAll('.icon-btn').forEach((el) => {
            el.classList.remove('hidden');
          })
          target_form.classList.add('hidden');
          if (target_form.querySelector('input') != null) {
            target_form.querySelector('input').value = '';
          }
          isClicked = true;
          setTimeout(function(){
            isClicked = false;
          },10);
          this.removeEventListener('click', arguments.callee, false);
        }
      }
    });
  }

  function fetchCategoryForm(element) {
    form = document.querySelector(element.getAttribute('data-target'));
    initial_top = form.offsetTop
    initial_left = form.offsetLeft
    form.style.top = (element.offsetTop - 7).toString() + 'px';
    form.style.left = element.offsetLeft.toString() + 'px';
    form.classList.toggle('hidden');
    setTimeout(function(){
      window.addEventListener('click', function(e) {
        if (outsideClick(e, form) && outsideClick(e, element.parentNode)) {
          form.style.top = initial_top + 'px';
          form.style.left = initial_left + 'px';
          form.classList.toggle('hidden');
          form.querySelector('input').value = '';
          this.removeEventListener('click', arguments.callee, false);
        }
      })
    },10);
  }

  // Close the dropdown if the user clicks outside of it
  window.onclick = function(event) {
    if (!event.target.matches('.filter-dropbtn')) {
      var dropdowns = document.getElementsByClassName("filter-dropdown-content");
      var i;
      for (i = 0; i < dropdowns.length; i++) {
        var openDropdown = dropdowns[i];
        if (openDropdown.classList.contains('show')) {
          openDropdown.classList.remove('show');
        }
      }
    }
  }

  $('.filter-dropbtn').click(function(){
    $(this).parent().toggleClass('open');
  });

  filter_btn = document.querySelector('.mobile-filter-btn')
  close_btn = document.querySelector('#close-btn')
  bookletcontainer = document.getElementById('booklet-container')
  filter_slider = document.querySelector('.filter-dropdown-form')
  filter_btn.addEventListener('click', (event) => {
    console.log('mesballs');
    filter_slider.style.width = "100%";
    filter_slider.style.zindex = "100";
  })

  close_btn.addEventListener('click', (event) => {
    filter_slider.style.width = "0px";
    filter_slider.style.zindex = "100";
    filter_slider.style.padding = "0px";
  })
</script>
