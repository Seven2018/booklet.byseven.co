<% interview_set = Interview.find_by(employee: employee, campaign: campaign).set %>
<% interviews = interview_set.interviews.compact %>
<% employee_view = current_user == employee %>
<% manager_view = current_user == selected_interviewer || CampaignPolicy.new(current_user, @campaign).show? %>
<% interview_form = interviews.first.interview_form %>

<% if employee_view || manager_view %>

  <div class="campaign-show__card campaign-show__card-<%= campaign.campaign_type %>">

    <div class="campaign-show__card-overlay hidden"></div>
    <div class="campaign-card__options" onclick="openContentMenu(this);">

      <% if manager_view %>

        <i class="fas fa-ellipsis-v"></i>

        <div class="content-dropdown hidden">

          <%= link_to t('see_profile'), user_path(employee) %>
          <%= link_to t('send_invitation_email'), send_notification_email_path(id: campaign.id, user_id: employee.id, email_type: 'invite'), remote: true %>
          <%= link_to t('campaigns.show.send_reminder_email'), send_notification_email_path(id: campaign.id, user_id: employee.id, email_type: 'reminder'), remote: true %>
          <a data-toggle='modal' data-target='#editDeadline-<%= employee.id %>'><%= t('campaigns.show.edit_interview_deadline') %></a>

          <% if CampaignPolicy.new(current_user, @campaign).remove_interview_set? ||
            !interview_set.employee_interview&.submitted? %>
            <a data-toggle='modal' data-target='#removeParticipant-<%= employee.id %>'><%= t('campaigns.show.remove_from_campaign') %></a>
          <% end %>

            <% if CampaignPolicy.new(current_user, @campaign).can_unlock? %>
              <% interviews.select{|x| x&.locked_at&.present?}.each do |interview| %>
                <% unless interviews.count == 3 && interviews.last.locked? && !interview.crossed? %>
                  <%= link_to t('campaigns.show.unlock_interview', type: interview.label), unlock_interview_path(interview_id: interview.id, interviewer_id: selected_interviewer&.id), remote: true %>
                <% end %>
              <% end %>
            <% end %>

        </div>

      <% end %>

    </div>

    <div class="campaign-show__card-profile">
      <img src="<%= employee.picture %>" alt="<%= employee.fullname %>" class='avatar-large' onerror='this.onerror=null;this.src="<%= asset_url('empty-avatar.png', type: :image) %>";'>
      <p><%= employee.lastname.upcase %> <%= employee.firstname.titleize %></p>
    </div>

    <div class="campaign-show__card-interviews">

      <% if interview_form.answerable_by_manager? || interview_form.answerable_by_employee? %>
        <% interview = Interview.find_by(campaign_id: campaign.id, employee_id: employee.id) %>
        <% active_link =
          if interview.manager?
            interview.submitted? && employee_view || manager_view && (current_user == interview.interviewer)
          else
            interview.submitted? && manager_view || employee_view
          end
        %>

        <div id='interview-<%= interview.id %>' class="campaign-show__card-interview">
          <% if active_link %>
            <%= link_to '', interview_path(interview), class: 'stretched-link' %>
          <% end %>
          <div>
            <p><%= interview.title %> review <br><em class='campaign-show__card-deadline'><%= "Until #{interview.date}" %></em></p>
            <% if interview.locked? %>
              <p class="campaign-show__card-interview-status--complete">
                <%= t('locked').upcase_first %> !
              </p>
            <% elsif interview.submitted? %>
              <p class="campaign-show__card-interview-status--complete">
                <%= t('completed').upcase_first %> !
              </p>
            <% else %>
              <p class="campaign-show__card-interview-status--incomplete">
                Not <%= t('not_completed').upcase_first %>
              </p>
            <% end %>
          </div>
          <% if active_link %>
            <span class="iconify" data-icon="fontisto:angle-right"></span>
          <% end %>
        </div>

        <div class="campaign-show__card-interviews-info-incomplete mb-2rem">
          <p><%= t('campaigns.show.update_answer', type: interview.label) %></p>
        </div>

      <% else %>
        <% interviews = Interview.where(campaign_id: campaign.id, employee_id: employee.id) %>
        <% employee_interview = interviews.find_by(label: 'Employee') %>
        <% manager_interview = interviews.find_by(label: 'Manager') %>
        <% crossed_interview = interviews.find_by(label: 'Crossed') %>
        <% crossed_availability =
          employee_interview&.submitted? &&
          manager_interview&.submitted? &&
          (manager_view || crossed_interview&.submitted?) if interview_form.cross %>
        <% interviews = [employee_interview, manager_interview, crossed_interview].compact %>

        <% interview_title = {'Employee' => "employee_review",
                              'Manager' => "manager_review",
                              'Crossed' => "cross_review"} %>

        <% interviews.each do |interview| %>
          <% user_is_manager = current_user == interview.interviewer %>

          <% active_link = (interview.crossed? && crossed_availability) ||
                           ((employee_view && interview.employee?) ||
                           (user_is_manager && (interview.manager? || interview.submitted?)) ||
                           (interview.submitted? && !manager_view && !interview.manager?)) %>

          <div id='interview-<%= interview.id %>' class="campaign-show__card-interview">
            <% if active_link %>
              <%= link_to '', interview_path(interview), class: 'stretched-link' %>
            <% end %>
            <div>
              <p><%= t interview_title[interview.label] %>
                <% if interview.crossed? %>
                  <em class='campaign-show__card-deadline'><%= "- #{t('until_date')} #{l(interview.date, format: :long)}" %></em>
                <% end %>
              </p>
              <% if interview.locked? %>
                <p class="campaign-show__card-interview-status--complete">
                  <%= t('locked').upcase_first %> !
                </p>
              <% elsif interview.submitted? %>
                <p class="campaign-show__card-interview-status--complete">
                  <%= t('completed').upcase_first %> !
                </p>
              <% elsif interview.crossed? && !crossed_availability && manager_view %>
                <p class="campaign-show__card-interview-status--unavailable">
                  <%= t('not_available_yet').upcase_first %>
                </p>
              <% else %>
                <p class="campaign-show__card-interview-status--incomplete">
                  <%= t('not_completed').upcase_first %>
                </p>
              <% end %>
            </div>
            <% if active_link %>
              <span class="iconify" data-icon="fontisto:angle-right"></span>
            <% end %>
          </div>

        <% end %>

        <% if crossed_interview.present? %>
          <% if crossed_interview.locked? %>
            <div class="campaign-show__card-interviews-info-locked mb-1rem">
              <p><%= t('interview').upcase_first %> <%= t('locked') %></p>
              <span class="iconify" data-icon="akar-icons:circle-check-fill"></span>
            </div>
          <% elsif crossed_interview.submitted? %>
            <div class="campaign-show__card-interviews-info-complete mb-1rem">
              <p><%= t('interview').upcase_first %> <%= t('completed') %> !</p>
            </div>
          <% else %>
            <div class="campaign-show__card-interviews-info-incomplete mb-1rem">
              <p><%= t('campaigns.show.start_cross_when_all_done') %></p>
            </div>
          <% end %>
        <% end %>

      <% end %>
    </div>

    <!----------->
    <!-- MODAL -->
    <!----------->

    <div class='modal fade' id='editDeadline-<%= employee.id %>' tabindex='-1' role='dialog' aria-labelledby='myModalLabel' data-keyboard="false" data-backdrop="static">
      <div class='modal-dialog modal-date' role='document' style='border-radius: 20px'>
        <%= render 'campaigns/modals/edit_deadline', campaign: campaign, employee: employee, interview: Interview.where(campaign_id: campaign.id, employee_id: employee.id).first %>
      </div>
    </div>

    <div class='modal fade' id='removeParticipant-<%= employee.id %>' tabindex='-1' role='dialog' aria-labelledby='myModalLabel' data-keyboard="false" data-backdrop="static">
      <div class='modal-dialog modal-sm' role='document' style='border-radius: 20px'>
        <%= render 'campaigns/modals/remove_participant', employee: employee, selected_interviewer: selected_interviewer %>
      </div>
    </div>

    <!----------->

  </div>

<% end %>
