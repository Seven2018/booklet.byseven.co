<% manager = @campaign.owner %>

<div class="campaign-show__main">
  <%= link_to campaigns_path, class: "booklet__back-button" do %>
    <span class="iconify" data-icon="bi:arrow-left"></span>
    <p>Back</p>
  <% end %>
  <div class="campaign-show__header">
    <div class="campaign-show__header-banner">
      <div class="campaign-show__header-banner-text">
        <h1>Manage the campaign</h1>
        <p>There are <%= @campaign.employees.distinct.count %> employees in this campaign.<br>
          You can add or remove employees, change the reviews deadlines, <br>or change the campaign manager.
        </p>
      </div>
      <div class="campaign-show__header-banner-img">
        <%= image_tag('campaigns-show-banner.png') %>
      </div>
    </div>
    <div class="campaign-show__header-infos">
      <%= render 'campaigns/show/show_header_infos', campaign: @campaign %>
    </div>
  </div>
  <div class="campaign-show__interviews-list">
    <%= render 'campaigns/show/show_interviews', campaign: @campaign %>
  </div>
</div>


<!------------>
<!-- HIDDEN -->
<!------------>

<a id='campaignInfoMessageTrigger' class='hidden' data-toggle='modal' data-target='#campaignInfoMessage'></a>

<!------------>
<!-- MODALS -->
<!------------>

<div class='modal fade' id='selectOwner' tabindex='-1' role='dialog' aria-labelledby='myModalLabel' data-keyboard="false" data-backdrop="static">
  <div class='modal-dialog modal-sm' role='document' style='border-radius: 20px'>
    <%= render 'campaigns/show/modal_confirm_owner' %>
  </div>
</div>

<div class='modal fade' id='addParticipant' tabindex='-1' role='dialog' aria-labelledby='myModalLabel' data-keyboard="false" data-backdrop="static">
  <div class='modal-dialog modal-sm' role='document' style='border-radius: 20px'>
    <%= render 'campaigns/modals/add_participant' %>
  </div>
</div>

<div class='modal fade' id='campaignInfoMessage' tabindex='-1' role='dialog' aria-labelledby='myModalLabel' data-keyboard="false" data-backdrop="static">
  <div class='modal-dialog modal-sm' role='document' style='border-radius: 20px'>
    <%= render 'campaigns/modals/campaign_info_message', message: '' %>
  </div>
</div>


<!---------------->
<!-- JAVASCRIPT -->
<!---------------->

<script src="https://cdnjs.cloudflare.com/ajax/libs/easy-autocomplete/1.3.5/jquery.easy-autocomplete.min.js"></script>

<script>

  ///////////
  // TOOLS //
  ///////////

  formGuardian = false;

  function outsideClick(event, notelem) {
    notelem = $(notelem); // jquerize (optional)
    // check outside click for multiple elements
    var clickedOut = true, i, len = notelem.length;
    for (i = 0;i < len;i++)  {
        if (event.target == notelem[i] || notelem[i].contains(event.target)) {
            clickedOut = false;
        }
    }
    if (clickedOut) return true;
    else return false;
  }


  ///////////////////////
  // CAMPAIGN DROPDOWN //
  ///////////////////////

  function openContentMenu(element) {
    dropdown = element.parentNode.querySelector('.content-dropdown')
    overlay = element.closest('.campaign-show__card').querySelector('.campaign-show__card-overlay')

    if (!dropdown.classList.contains('hidden')) {
      dropdown.classList.add('hidden')
      overlay.classList.add('hidden')
      return
    }
    dropdown.classList.remove('hidden')
    overlay.classList.remove('hidden')
    formGuardian = true
    setTimeout(function(){
      formGuardian = false
    }, 1);
    window.addEventListener('click', function(e) {
      if (outsideClick(e, dropdown) && formGuardian == false) {
        formGuardian = true
        setTimeout(function(){
          formGuardian = false
        }, 1);
        dropdown.classList.add('hidden')
        overlay.classList.add('hidden')
        this.removeEventListener('click', arguments.callee, false)
      }
    });
  }


  ////////////////////
  // SELECT MANAGER //
  ////////////////////

  function showManagerSearch(element) {
    current_manager = document.querySelector('.campaign-show__header-infos-controls-manager-display')
    open_button = document.querySelector('.campaign-show__header-infos-controls-manager-edit')
    cancel_button = document.getElementById('cancel_owner')
    manager_search = document.querySelector('.campaign-show__header-infos-controls-manager-search')
    manager_input = manager_search.querySelector('input')
    target_width = current_manager.offsetWidth

    manager_search.style.width = target_width.toString() + 'px'
    manager_input.style.width = (target_width).toString() + 'px'
    current_manager.classList.toggle('hidden')
    manager_search.classList.toggle('hidden')
    open_button.classList.toggle('hidden')
    cancel_button.classList.toggle('hidden')
  }

  function swapManagerSearchButton(select = false) {
    confirm_button = document.getElementById('select_owner')
    cancel_button = document.getElementById('cancel_owner')

    if (select) {
      confirm_button.classList.remove('hidden')
      cancel_button.classList.add('hidden')
    } else {
      confirm_button.classList.add('hidden')
      cancel_button.classList.remove('hidden')
    }
  }


  ///////////////////
  // AUTO COMPLETE //
  ///////////////////

  $input_participant = $("#search_participant");
  $input_manager = $("#search_manager");

  var options_participant = {
    listLocation: "users",
    getValue: 'name',
    url: function(phrase) {
      return "/users_search.json?search=" + phrase
    },
    list: {
      onChooseEvent: function() {
        user_id = $input_participant.getSelectedItemData().id
        button = document.getElementById('add-participant-button')
        new_url = new URL(button.href)
        new_url.searchParams.set('user_id', user_id)
        button.href = new_url.href
      },
      match: {
        enabled: true
      }
    }
  }

  var options_manager = {
    listLocation: "users",
    getValue: 'name',
    url: function(phrase) {
      return "/users_search.json?manager=true&search=" + phrase
    },
    list: {
      onChooseEvent: function() {
        user_id = $input_manager.getSelectedItemData().id
        button = document.getElementById('select_owner_link')
        new_url = new URL(button.href)
        new_url.searchParams.set('user_id', user_id)
        button.href = new_url.href
        swapManagerSearchButton(true)
      },
      match: {
        enabled: true
      }
    }
  }

  $input_participant.easyAutocomplete(options_participant);
  $input_manager.easyAutocomplete(options_manager);
</script>
