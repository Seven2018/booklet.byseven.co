<div class="campaign-show__main">
  <%= render_component BackComponent.new(fallback: campaigns_path) %>
  <div class="campaign-show__header">
    <div class="campaign-show__header-banner">
      <div class="campaign-show__header-banner-text">
        <h1 class="fs-3rem">Manage the campaign</h1>
        <p>There are <%= @campaign.employees.distinct.count %> employees in this campaign.<br>
          You can add or remove employees, change the reviews deadlines, <br>or change the campaign manager.
        </p>
      </div>
      <div class="campaign-show__header-banner-img">
        <%= image_tag('campaigns-show-banner.png') %>
      </div>
    </div>
    <div class="campaign-show__header-infos">
      <%= render 'campaigns/show/show_header_infos', campaign: @campaign, selected_interviewer: @selected_interviewer %>
    </div>
  </div>
  <div class="campaign-show__interviews-list">
    <%= render 'campaigns/show/show_interviews', campaign: @campaign,
                                                 employees: @employees,
                                                 selected_interviewer: @selected_interviewer %>
  </div>
</div>


<!------------>
<!-- HIDDEN -->
<!------------>

<a id='campaignInfoMessageTrigger' class='hidden' data-toggle='modal' data-target='#campaignInfoMessage'></a>
<a id='sendEmailSuccessTrigger' class='hidden' data-toggle='modal' data-target='#sendEmailSuccess'></a>

<!------------>
<!-- MODALS -->
<!------------>

<% if CampaignPolicy.new(current_user, @campaign).add_interview_set? %>
  <div class='modal fade' id='addParticipant' tabindex='-1' role='dialog' aria-labelledby='myModalLabel' data-keyboard="false" data-backdrop="static">
    <div id='add_participant-modal' class='modal-dialog modal-sm' role='document' style='border-radius: 20px'>
      <%= render 'campaigns/modals/add_participant', campaign: @campaign, selected_interviewer: @selected_interviewer %>
    </div>
  </div>
<% end %>

<div class='modal fade' id='sendEmailSuccess' tabindex='-1' role='dialog' aria-labelledby='myModalLabel' data-keyboard="false" data-backdrop="static">
  <div class='modal-dialog' role='document' style='border-radius: 20px'>
    <%= render 'campaigns/modals/send_notification_email_done', email_type: 'Invitation' %>
  </div>
</div>

<div class='modal fade' id='campaignInfoMessage' tabindex='-1' role='dialog' aria-labelledby='myModalLabel' data-keyboard="false" data-backdrop="static">
  <div class='modal-dialog modal-sm' role='document' style='border-radius: 20px'>
    <%= render 'campaigns/modals/campaign_info_message', message: '' %>
  </div>
</div>


<!---------------->
<!-- JAVASCRIPT -->
<!---------------->

<script src="https://cdnjs.cloudflare.com/ajax/libs/easy-autocomplete/1.3.5/jquery.easy-autocomplete.min.js"></script>

<script>

  ///////////
  // TOOLS //
  ///////////

  formGuardian = false;

  function outsideClick(event, notelem) {
    notelem = $(notelem); // jquerize (optional)
    // check outside click for multiple elements
    var clickedOut = true, i, len = notelem.length;
    for (i = 0;i < len;i++)  {
        if (event.target == notelem[i] || notelem[i].contains(event.target)) {
            clickedOut = false;
        }
    }
    if (clickedOut) return true;
    else return false;
  }

  function submitForm(element) {
    element.closest('form').querySelector('.hidden-submit').click()
  }

  ///////////////////////
  // CAMPAIGN DROPDOWN //
  ///////////////////////

  function openContentMenu(element) {
    dropdown = element.parentNode.querySelector('.content-dropdown')
    overlay = element.closest('.campaign-show__card').querySelector('.campaign-show__card-overlay')

    if (!dropdown.classList.contains('hidden')) {
      dropdown.classList.add('hidden')
      overlay.classList.add('hidden')
      return
    }
    dropdown.classList.remove('hidden')
    overlay.classList.remove('hidden')
    formGuardian = true
    setTimeout(function(){
      formGuardian = false
    }, 1);
    window.addEventListener('click', function(e) {
      if (outsideClick(e, dropdown) && formGuardian == false) {
        formGuardian = true
        setTimeout(function(){
          formGuardian = false
        }, 1);
        dropdown.classList.add('hidden')
        overlay.classList.add('hidden')
        this.removeEventListener('click', arguments.callee, false)
      }
    });
  }


  ////////////////
  // PAGINATION //
  ////////////////

  function changePage(direction) {
    page_value = document.querySelector('#select_page')
    submit_button = page_value.closest('form').querySelector('.hidden-submit')


    if(direction == 'next') {
      page_value.value = (parseInt(page_value.value,10) + 1).toString()
    } else {
      page_value.value = (parseInt(page_value.value,10) - 1).toString()
    }
    submit_button.click()
  }


  /////////////////
  // SELECT DATE //
  /////////////////

  function selectInterviewDate(element) {
    form = element.closest('form')
    date_display = element.closest('.campaign-show__card').querySelector('.campaign-show__card-deadline')

    date_display.innerText = '- Until ' + element.value
    form.querySelector('.hidden-submit').click()
    document.querySelector('.modal.show').querySelector('.cancel-close').click()
  }


  ///////////////////
  // AUTO COMPLETE //
  ///////////////////

  $input_participant = $("#search_participant");

  var options_participant = {
    listLocation: "users",
    getValue: 'name',
    url: function(phrase) {
      return `/campaigns/users.json?id=<%= @campaign.id %>&search=${phrase}`
    },
    list: {
      onChooseEvent: function() {
        user_id = $input_participant.getSelectedItemData().id
        interviewer_id = document.querySelector('#search_add_to_interviewer_id').value
        button = document.getElementById('add-participant-button')
        new_url = new URL(button.href)
        new_url.searchParams.set('user_id', user_id)
        new_url.searchParams.set('add_to_interviewer_id', interviewer_id)
        button.href = new_url.href
      },
      match: {
        enabled: true
      }
    }
  }

  $input_participant.easyAutocomplete(options_participant);
</script>
