<div class='bkt-bg-light-grey2 bkt-page-container-min-height d-flex justify-content-center align-items-start py-10rem'>

  <div class="from_medium__h-60vh"
       style="position: sticky; top: 18rem;">

    <div class="bkt-progress">

      <div class="bkt-progress-thread"></div>

      <% CampaignDraft::PROGRESS_STATES.each do |state, state_label| %>

        <%= link_to send "edit_campaign_draft_#{state}_path".to_sym do %>

          <div class="bkt-progress-pearl bkt-progress-pearl-blue <%= @campaign.progress_state_klass(state, controller_name) %>" data-title='<%= state_label %>'>
            <% if @campaign.state_set_or_above?(state) %>
              <i class="fas fa-check"></i>
            <% end %>
          </div>

        <% end %>

      <% end %>

    </div>

  </div>

  <div style='margin: 0 5%;'></div>

  <div class="bkt-box-shadow p-4 bkt-bg-white rounded-20px min-w-40vw pos-rel mt-8rem"
       data-controller="<%= 'interviews--campaign-drafts-templates' if @controller_action == :templates_edit %>">

    <div class="width-100 d-flex justify-content-center pos-abs"
         style="top: -10rem; left: 0; right: 0;">

      <h1 class="fs-2_4rem font-weight-600 bkt-dark-grey">New campaign</h1>

      <div class="pos-abs"
           style="top: 0; right: 0;">
        <%= render_component Buttons::BackButton.new(fallback: trainings_reports_path) do %>

          <div class="d-flex justify-content-center align-items-center height-4rem width-4rem rounded-20px bkt-box-shadow-medium bkt-bg-white bkt-bg-light-grey5-hover">
            <span class="iconify bkt-dark-grey-important m-0" data-icon="bi:x" data-width="35" data-height="35"></span>
          </div>

        <% end %>
      </div>

    </div>

    <%= form_with url: send("campaign_draft_#{controller_name}_path".to_sym), method: :patch, local: true do |f| %>
      <%= render "campaign_draft/form_#{controller_name}", campaign: @campaign %>
      <% if @controller_action.to_sym == :launches_edit %>
        <%= f.hidden_field :send_email %>
        <div class="d-flex justify-content-center pt-5">
          <a class='bkt-btn-blue bkt-white' data-toggle='modal' data-target='#launchCampaign'>
            Launch Campaign
          </a>
          <%= f.submit '', class: 'hidden-submit hidden' %>

          <!----------->
          <!-- MODAL -->
          <!----------->

          <div id='launchCampaign'
               class='modal action-modal fade'
               tabindex='-1'
               role='dialog'
               data-keyboard="false"
               data-backdrop="static">

            <div class='modal-dialog action-modal__dialog' role='document'>
              <%= render 'campaigns/modals/send_notification_email_on_confirm' %>
            </div>

          </div>

          <!----------->
        </div>
      <% else %>
        <div class="d-flex justify-content-end pt-5">
          <button class='bkt-btn-blue'><p class="mr-3">Next</p> <i class="fa fa-arrow-right"></i></button>
        </div>
      <% end %>
    <% end %>

    <div id="users_search" class="pos-abs <%= 'd-none' unless @controller_action == :participants_edit %>" style='left: 1.5rem; bottom: 27rem;'>

      <%= simple_form_for :search, html: { class: 'bkt-select-autocomplete' }, method: :get do |f| %>
        <%= f.text_field :manager, placeholder: 'Search in Managers',
                                   value: @campaign.default_interviewer&.fullname,
                                   label: false,
                                   data: {behavior: 'autocomplete'} %>
      <% end %>

    </div>

    <div id="templates_search"
         class="pos-abs <%= 'd-none' unless @controller_action == :templates_edit %>"
         data-controller="tools--easyautocomplete"
         data-interviews--campaign-drafts-templates-target="singleTemplateContainer"
         style='left: 1.5rem; right: 1.5rem; bottom: 8rem;'>

      <%= simple_form_for :search, html: { class: 'bkt-select-autocomplete width-100' }, method: :get do |f| %>

        <%= f.text_field :template, placeholder: 'Search in Templates',
                                   value: @campaign.default_template&.title || "",
                                   label: false,
                                   data: { behavior: 'autocomplete' } %>

      <% end %>

    </div>

  </div>

</div>

<% if params[:debug] %>
  <div class="fs-2_4rem">
    <%= @campaign.data %>
  </div>
<% end %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/easy-autocomplete/1.3.5/jquery.easy-autocomplete.min.js"></script>

<script>
  $input_manager = $("#search_manager");
  $input_template = $("#search_template");

  var options_manager = {
    listLocation: "users",
    getValue: 'name',
    url: function(phrase) {
      return "/users_search.json?manager=true&search=" + phrase
    },
    list: {
      onChooseEvent: function() {
        user_id = $input_manager.getSelectedItemData().id
        document.getElementById('default_interviewer_id').value = user_id
      },
      match: {
        enabled: true
      }
    }
  }

  var options_template = {
    listLocation: "templates",
    getValue: 'title',
    url: function(phrase) {
      return "/templates_search.json?search=" + phrase
    },
    list: {
      onChooseEvent: function() {
        template_id = $input_template.getSelectedItemData().id
        document.getElementById('default_template_id').value = template_id
      },
      maxNumberOfElements: Infinity,
      match: {
        enabled: true
      }
    }
  }

  $input_manager.easyAutocomplete(options_manager).click(function(){
    $(this).triggerHandler(jQuery.Event("keyup", { keyCode: 65, which: 65}))
  });

  $input_manager.easyAutocomplete(options_manager).keyup(function(event){
    if (event.which == 8 && $(this).val() == '') {
      $(this).triggerHandler(jQuery.Event("keyup", { keyCode: 65, which: 65}))
    }
  });

  $input_template.easyAutocomplete(options_template).click(function(){
    $(this).triggerHandler(jQuery.Event("keyup", { keyCode: 65, which: 65}))
  });

  $input_template.easyAutocomplete(options_template).keyup(function(event){
    if (event.which == 8 && $(this).val() == '') {
      $(this).triggerHandler(jQuery.Event("keyup", { keyCode: 65, which: 65}))
    }
  });
</script>
