<div class="workshop-index">
  <div id="index-controls">
    <h3>Workshops List</h3>
    <div id="index-buttons">
      <% if ['Super Admin', 'Admin', 'HR'].include?(current_user.access_level) %>
        <%= link_to new_workshop_path do %>
          <button class="btn btn-edit-white btn-edit-icon"><i class="fas fa-plus"></i></button>
        <% end %>
      <% end %>
      <a><button id='btn-edit-filter' class="btn btn-edit-white btn-edit-icon"><i class="fas fa-sliders-h"></i></button></a>
      <% if params[:search] %>
        <%= simple_form_for :search, url: workshops_path, html: { class: 'search-bar' }, method: 'GET' do |f| %>
          <%= f.input :title, placeholder: params[:search][:title], label: false %>
          <%= link_to workshops_path, class: 'search-close' do %>
            <i class="far fa-times-circle"></i>
          <% end %>
        <% end %>
      <% else %>
        <a>
          <button class="btn btn-edit-white btn-edit-icon btn-search"><i class="fas fa-search"></i></button>
        </a>
        <%= simple_form_for :search, url: workshops_path, html: { class: 'search-bar hidden' }, method: 'GET' do |f| %>
          <%= f.input :title, placeholder: 'Search', label: false %>
            <a class='search-close'>
              <i class="far fa-times-circle"></i>
            </a>
        <% end %>
      <% end %>
    </div>
  </div>
  <div id="workshop-index-list-filters" class='hidden'>
    <%= simple_form_for :filter, url: filter_workshops_path, method: 'GET' do |f| %>
      <div id="checkbox">
        <%= collection_check_boxes(:workshop, :category_ids, Category.all, :id, :title) do |b| %>
          <%= b.label class: 'label-checkbox', style: 'color:black;' do %>
            <%= b.check_box + b.text %>
          <% end %>
        <% end %>
      </div>
      <script>
        $('#checkbox input:checkbox:checked').parent().toggleClass('checked-box');
        $('#checkbox input:checkbox').change(function () {
          $(this).parent().toggleClass('checked-box');
        });
      </script>
      <div style="display:flex;justify-content:center;margin-top:30px;">
        <%= button_tag :submit, class: 'btn btn-edit-green btn-edit-icon' do %>
          <i class="fas fa-save"></i>
        <% end %>
      </div>
    <% end %>
  </div>
  <script>
    filterButton = document.getElementById('btn-edit-filter');
    filterDiv = document.getElementById('workshop-index-list-filters');
    filterButton.addEventListener('click', (event) => {
      filterDiv.classList.toggle('hidden');
    })
  </script>
  <div class='workshop-index-list'>
    <% category_array = [] %>
    <% @workshops.each do |workshop| %>
      <% category_array << workshop.categories %>
    <% end %>
    <% category_array = category_array.uniq.reject { |c| c.empty? } %>
    <% category_array.each do |category| %>
      <p class='workshop-index-list-category-title'><%= category.first.title %></p>
      <% @workshops.joins(:workshop_categories).where(workshop_categories: {category_id: category.first.id}).each do |workshop| %>
        <%= link_to workshop_path(workshop) do %>
          <div class='workshop-index-card'>
            <div class='workshop-index-image' style="background-image:url('<%= workshop.image %>');">
            </div>
            <div class="workshop-index-infos">
              <p><%= workshop.title %></p>
            </div>
          </div>
        <% end %>
      <% end %>
    <% end %>
    <% if @workshops.left_joins(:workshop_categories).where(workshop_categories: {id: nil}) && params[:filter].nil?%>
      <p class='workshop-index-list-category-title'>Others</p>
      <% @workshops.left_joins(:workshop_categories).where(workshop_categories: {id: nil}).each do |workshop| %>
        <%= link_to workshop_path(workshop) do %>
          <div class='workshop-index-card'>
            <div class='workshop-index-image' style="background-image:url('<%= workshop.image %>');">
            </div>
            <div class="workshop-index-infos">
              <p><%= workshop.title %></p>
            </div>
          </div>
        <% end %>
      <% end %>
    <% end %>
  </div>
</div>

<script>
  searchButton = document.querySelector('.btn-search');
  searchBar = document.querySelector('.search-bar');
  searchClose = document.querySelector('.search-close');
  searchButton.addEventListener('click', (event) => {
    searchButton.classList.toggle('hidden');
    searchBar.classList.toggle('hidden');
  })
  searchClose.addEventListener('click', (event) => {
    searchButton.classList.toggle('hidden');
    searchBar.classList.toggle('hidden');
  })
</script>
